# ============================================================================
# YTFY Nginx Cache Configuration
# ============================================================================
# Purpose: Advanced caching strategies for optimal performance
# ============================================================================

# ==========================================================================
# Cache Key Definitions
# ==========================================================================

# Default cache key includes scheme, host, and request URI
# This ensures proper cache separation for different endpoints

# Cache key for API requests (includes relevant headers)
# Note: Main proxy_cache_key is set in location blocks

# ==========================================================================
# Static Assets Cache Configuration
# ==========================================================================

# Proxy cache settings for static assets
# These settings are applied in location blocks using proxy_cache directive

# Static cache zone settings (defined in main nginx.conf):
# - Zone: static_cache
# - Size: 10GB
# - Inactive: 7 days

# ==========================================================================
# API Response Cache Configuration
# ==========================================================================

# API cache zone settings (defined in main nginx.conf):
# - Zone: api_cache
# - Size: 1GB
# - Inactive: 1 hour

# Stale-while-revalidate configuration
# Serves stale content while updating cache in background

# Default stale settings (used in location blocks)
# proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
# proxy_cache_background_update on;

# ==========================================================================
# Media Streaming Cache Configuration
# ==========================================================================

# Media cache zone settings (defined in main nginx.conf):
# - Zone: media_cache
# - Size: 20GB
# - Inactive: 24 hours

# Slice-based caching for large media files
# Enables byte-range request caching
slice 1m;
proxy_cache_key $uri$is_args$args$slice_range;

# ==========================================================================
# Micro-cache Configuration
# ==========================================================================

# Micro-cache zone settings (defined in main nginx.conf):
# - Zone: micro_cache
# - Size: 100MB
# - Inactive: 1 minute

# Micro-caching helps with:
# - Thundering herd problem
# - Brief traffic spikes
# - Reducing backend load for frequently accessed content

# ==========================================================================
# Cache Bypass Rules
# ==========================================================================

# Set cache bypass based on various conditions
# These maps are used in location blocks

# Bypass cache for authenticated requests
map $http_authorization $auth_bypass {
    default 0;
    ~.+ 1;
}

# Bypass cache for POST/PUT/DELETE requests
map $request_method $method_bypass {
    default 0;
    POST 1;
    PUT 1;
    DELETE 1;
    PATCH 1;
}

# Bypass cache based on cookies (e.g., session cookies)
map $http_cookie $cookie_bypass {
    default 0;
    ~*session 1;
    ~*auth 1;
}

# Combined bypass variable
map "$auth_bypass:$method_bypass:$cookie_bypass" $combined_bypass {
    default 0;
    ~*1 1;
}

# ==========================================================================
# Cache Purge Configuration (requires nginx-cache-purge module)
# ==========================================================================

# Uncomment if nginx-cache-purge module is installed
# geo $purge_allowed {
#     default 0;
#     127.0.0.1 1;
#     10.0.0.0/8 1;
# }

# ==========================================================================
# Cache Status Headers
# ==========================================================================

# Add cache status header to responses
# Values: HIT, MISS, BYPASS, EXPIRED, STALE, UPDATING, REVALIDATED
# This is added in location blocks using: add_header X-Cache-Status $upstream_cache_status;

# ==========================================================================
# Browser Cache Headers Map
# ==========================================================================

# Map file extensions to cache durations
map $uri $cache_control_header {
    default "public, max-age=3600";
    
    # Immutable assets (hashed filenames)
    ~*\.[0-9a-f]{8,}\.(js|css)$ "public, immutable, max-age=31536000";
    ~*\.chunk\.(js|css)$ "public, immutable, max-age=31536000";
    
    # Images and fonts (long cache)
    ~*\.(png|jpg|jpeg|gif|ico|svg|webp|avif)$ "public, max-age=31536000, immutable";
    ~*\.(woff|woff2|ttf|eot)$ "public, max-age=31536000, immutable";
    
    # HTML files (short cache with revalidation)
    ~*\.html$ "public, max-age=3600, must-revalidate";
    
    # JSON data files (medium cache)
    ~*\.json$ "public, max-age=86400";
    
    # Service worker and manifest (no cache / short cache)
    ~*sw\.js$ "no-cache, no-store, must-revalidate";
    ~*manifest\.webmanifest$ "public, max-age=86400";
}

# ==========================================================================
# ETag Configuration
# ==========================================================================

# Enable ETags for static files
etag on;

# ==========================================================================
# Last-Modified Configuration
# ==========================================================================

# Enable last-modified header
if_modified_since before;

# ==========================================================================
# Cache Lock Configuration
# ==========================================================================

# Prevent multiple requests from populating the same cache entry
# This is configured per-location:
# proxy_cache_lock on;
# proxy_cache_lock_timeout 5s;
# proxy_cache_lock_age 5s;

# ==========================================================================
# Upstream Cache Configuration
# ==========================================================================

# Cache valid responses from upstream
# Configuration per cache type:

# Static files:
# proxy_cache_valid 200 7d;
# proxy_cache_valid 404 1m;

# API responses:
# proxy_cache_valid 200 30m;
# proxy_cache_valid 404 1m;
# proxy_cache_valid 500 502 503 504 0;

# Media files:
# proxy_cache_valid 200 206 24h;
# proxy_cache_valid 404 1m;

# Micro-cache:
# proxy_cache_valid 200 1s;
# proxy_cache_valid 200 5s;  (for sync/library endpoints)

# ==========================================================================
# Cache Revalidation
# ==========================================================================

# Enable cache revalidation using If-Modified-Since and If-None-Match
proxy_cache_revalidate on;

# Minimum time to consider content fresh
proxy_cache_min_uses 1;

# ==========================================================================
# Open File Cache (for static files served directly by nginx)
# ==========================================================================

# Cache file descriptors, information, and errors
open_file_cache max=10000 inactive=60s;
open_file_cache_valid 120s;
open_file_cache_min_uses 2;
open_file_cache_errors on;
