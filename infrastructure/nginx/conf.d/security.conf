# ============================================================================
# YTFY Nginx Security Configuration
# ============================================================================
# Purpose: Security headers and protection rules
# Standards: OWASP recommendations, A+ SSL rating
# ============================================================================

# ==========================================================================
# HTTP Security Headers
# ==========================================================================

# These headers are applied in server blocks using add_header directive
# Note: add_header is not inherited if any add_header is present in a location block

# Content Security Policy (CSP)
# Prevents XSS, data injection, and other code injection attacks
# 
# Directives explained:
# - default-src 'self': Default fallback for all resource types
# - script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:: Allow scripts from same origin, inline scripts, and eval
# - style-src 'self' 'unsafe-inline': Allow stylesheets from same origin and inline styles
# - img-src 'self' data: https: blob:: Allow images from same origin, data URIs, HTTPS, and blobs
# - media-src 'self' https: blob:: Allow media from same origin, HTTPS, and blobs
# - connect-src 'self' https: wss:: Allow connections to same origin, HTTPS APIs, and WebSockets
# - font-src 'self' data:: Allow fonts from same origin and data URIs
# - frame-ancestors 'self': Only allow embedding by same origin (clickjacking protection)
# - base-uri 'self': Restrict base URLs to same origin
# - form-action 'self': Restrict form submissions to same origin

# Map for Content-Security-Policy header value
map $uri $csp_header {
    default "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; media-src 'self' https: blob:; connect-src 'self' https: wss:; font-src 'self' data:; frame-ancestors 'self'; base-uri 'self'; form-action 'self';";
}

# ==========================================================================
# SSL/TLS Security Settings
# ==========================================================================

# These settings are included in the main nginx.conf http block:
# ssl_protocols TLSv1.2 TLSv1.3;
# ssl_ciphers - Modern cipher suite
# ssl_prefer_server_ciphers off;

# DH parameters for DHE ciphers (generate with: openssl dhparam -out dhparam.pem 4096)
# ssl_dhparam /etc/nginx/ssl/dhparam.pem;

# ECDH curve
ssl_ecdh_curve X25519:secp384r1;

# ==========================================================================
# Request Filtering
# ==========================================================================

# Block requests with suspicious user agents
map $http_user_agent $blocked_agent {
    default 0;
    ~*(?:curl|wget|python|java|perl|ruby|php|scrapy|scanner|nikto|sqlmap) 0;  # Allow legitimate tools
    ~*(?:bot|crawler|spider) 0;  # Allow search bots
    "" 1;  # Block empty user agents
}

# Block requests with suspicious methods
map $request_method $blocked_method {
    default 0;
    ~*(?:TRACE|TRACK) 1;
}

# ==========================================================================
# IP-based Access Control
# ==========================================================================

# Geo-based blocking (uncomment and configure as needed)
# geo $blocked_country {
#     default 0;
#     # Add country codes to block
#     # include /etc/nginx/geo/blocked_countries.conf;
# }

# Allow list for admin endpoints
geo $admin_allowed {
    default 0;
    127.0.0.1 1;
    ::1 1;
    10.0.0.0/8 1;
    172.16.0.0/12 1;
    192.168.0.0/16 1;
}

# ==========================================================================
# Request Size Limits
# ==========================================================================

# Maximum body size (uploads, POST data)
# Configured per-location for flexibility
# Default: 10m for API endpoints, 1m for others

# Maximum header size
# Configured in main nginx.conf:
# client_header_buffer_size 1k;
# large_client_header_buffers 4 8k;

# ==========================================================================
# Timeout Protection
# ==========================================================================

# Connection timeouts (configured in main nginx.conf)
# client_body_timeout 12;
# client_header_timeout 12;
# send_timeout 10;

# Slow loris attack protection
client_body_timeout 10s;
client_header_timeout 10s;

# ==========================================================================
# Rate Limiting Configuration
# ==========================================================================

# Rate limit zones are defined in main nginx.conf:
# limit_req_zone $binary_remote_addr zone=general:10m rate=100r/s;
# limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
# limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# Rate limit status codes
limit_req_status 429;
limit_conn_status 429;

# Rate limit log level
limit_req_log_level warn;
limit_conn_log_level warn;

# ==========================================================================
# Sensitive Path Protection
# ==========================================================================

# Block access to hidden files (except .well-known)
location ~ /\.(?!well-known) {
    deny all;
    return 404;
}

# Block access to backup files
location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)$ {
    deny all;
    return 404;
}

# Block access to source control directories
location ~ /\.(git|svn|hg) {
    deny all;
    return 404;
}

# Block access to sensitive files
location ~* /(composer\.(json|lock)|package(-lock)?\.json|yarn\.lock|\.env.*|Dockerfile|docker-compose\.yml)$ {
    deny all;
    return 404;
}

# ==========================================================================
# Clickjacking Protection
# ==========================================================================

# X-Frame-Options prevents embedding in iframes
# Configured in server block: add_header X-Frame-Options "SAMEORIGIN" always;

# Frame-ancestors CSP directive provides more granular control
# Configured in CSP header

# ==========================================================================
# XSS Protection
# ==========================================================================

# X-XSS-Protection enables browser's XSS filter
# Configured in server block: add_header X-XSS-Protection "1; mode=block" always;

# Note: X-XSS-Protection is deprecated in favor of CSP
# CSP script-src provides better XSS protection

# ==========================================================================
# MIME Type Sniffing Protection
# ==========================================================================

# X-Content-Type-Options prevents MIME type sniffing
# Configured in server block: add_header X-Content-Type-Options "nosniff" always;

# ==========================================================================
# Referrer Policy
# ==========================================================================

# Control what referrer information is included with requests
# Configured in server block: add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Options:
# - no-referrer: Never send referrer
# - no-referrer-when-downgrade: Send for same-security level
# - origin: Send only origin, not path
# - origin-when-cross-origin: Full for same-origin, origin for cross-origin
# - strict-origin-when-cross-origin: Like above, but no referrer for downgrade

# ==========================================================================
# Permissions Policy (formerly Feature Policy)
# ==========================================================================

# Restrict browser features
# Configured in server block: add_header Permissions-Policy "..." always;

# Policy restricts access to:
# - accelerometer, gyroscope, magnetometer: Motion sensors
# - camera, microphone: Media capture
# - geolocation: Location access
# - payment: Payment API
# - usb: USB device access

# ==========================================================================
# HSTS (HTTP Strict Transport Security)
# ==========================================================================

# Force HTTPS connections
# Configured in server block: add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

# Settings:
# - max-age=63072000: Remember for 2 years
# - includeSubDomains: Apply to all subdomains
# - preload: Allow inclusion in browser HSTS preload lists

# ==========================================================================
# Cross-Origin Policies
# ==========================================================================

# Cross-Origin Embedder Policy (COEP)
# Required for SharedArrayBuffer and high-resolution timers
# add_header Cross-Origin-Embedder-Policy "require-corp" always;

# Cross-Origin Opener Policy (COOP)
# Isolates browsing context
# add_header Cross-Origin-Opener-Policy "same-origin" always;

# Cross-Origin Resource Policy (CORP)
# Controls which origins can include this resource
# add_header Cross-Origin-Resource-Policy "same-site" always;

# ==========================================================================
# CORS Configuration
# ==========================================================================

# Map for detecting valid CORS origins
map $http_origin $cors_origin {
    default "";
    ~^https?://(music\.ml4-lab\.com|ytify\.nicesrv\.de|localhost:\d+)$ $http_origin;
}

# CORS headers (applied in location blocks as needed)
# add_header Access-Control-Allow-Origin $cors_origin always;
# add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
# add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
# add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;
# add_header Access-Control-Max-Age 86400 always;

# ==========================================================================
# Security Logging
# ==========================================================================

# Log format for security events
log_format security '$remote_addr - [$time_local] "$request" '
                    '$status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'blocked_agent=$blocked_agent blocked_method=$blocked_method';

# Security-specific access log (uncomment to enable)
# access_log /var/log/nginx/security.log security if=$blocked_agent;
# access_log /var/log/nginx/security.log security if=$blocked_method;

# ==========================================================================
# Bot Protection
# ==========================================================================

# Allow verified bots (Google, Bing, etc.)
# Block bad bots and scrapers

map $http_user_agent $is_crawler {
    default 0;
    ~*(?:googlebot|bingbot|slurp|duckduckbot|yandexbot|sogou|exabot|facebot|ia_archiver) 1;
}

# Robots.txt handling
location = /robots.txt {
    log_not_found off;
    access_log off;
}

# ==========================================================================
# Security Test Endpoint
# ==========================================================================

# Uncomment for security header testing
# location = /security-headers-test {
#     default_type text/plain;
#     return 200 "Security headers check endpoint";
# }
