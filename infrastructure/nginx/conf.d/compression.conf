# ============================================================================
# YTFY Nginx Compression Configuration
# ============================================================================
# Purpose: Brotli and Gzip compression for optimal transfer size
# Target: 70%+ compression ratio for text-based assets
# ============================================================================

# ==========================================================================
# Brotli Compression (Primary - better compression ratio)
# ==========================================================================

# Enable Brotli compression
brotli on;

# Compression level (0-11)
# Level 6 offers best balance of compression ratio vs CPU usage
# Higher levels (7-11) provide minimal size benefits for significant CPU cost
brotli_comp_level 6;

# Minimum length to compress (in bytes)
# Skip compression for tiny files where overhead exceeds benefit
brotli_min_length 256;

# Types of content to compress
# Comprehensive list covering all text-based content
brotli_types
    text/plain
    text/css
    text/xml
    text/javascript
    text/x-component
    text/richtext
    text/cache-manifest
    text/vcard
    text/vtt
    text/x-cross-domain-policy
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/manifest+json
    application/schema+json
    application/xml
    application/xml+rss
    application/xhtml+xml
    application/atom+xml
    application/rss+xml
    application/vnd.api+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-font-opentype
    application/x-web-app-manifest+json
    font/opentype
    font/otf
    font/ttf
    font/eot
    image/svg+xml
    image/x-icon
    image/vnd.microsoft.icon
    image/bmp;

# Enable serving pre-compressed .br files
# Allows pre-compression during build for maximum performance
brotli_static on;

# ==========================================================================
# Gzip Compression (Fallback for older browsers)
# ==========================================================================

# Enable Gzip compression
gzip on;

# Compression level (1-9)
# Level 6 for good compression without excessive CPU usage
gzip_comp_level 6;

# Minimum length to compress
gzip_min_length 256;

# Compress for proxied requests
gzip_proxied any;

# Enable Vary header for proper caching
gzip_vary on;

# Buffer settings for compression
gzip_buffers 16 8k;

# HTTP version for compression
gzip_http_version 1.1;

# Types of content to compress
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    text/x-component
    text/richtext
    text/cache-manifest
    text/vcard
    text/vtt
    text/x-cross-domain-policy
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/manifest+json
    application/schema+json
    application/xml
    application/xml+rss
    application/xhtml+xml
    application/atom+xml
    application/rss+xml
    application/vnd.api+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-font-opentype
    application/x-web-app-manifest+json
    font/opentype
    font/otf
    font/ttf
    font/eot
    image/svg+xml
    image/x-icon
    image/vnd.microsoft.icon
    image/bmp;

# Disable compression for IE6 (legacy support)
gzip_disable "MSIE [1-6]\.";

# Enable serving pre-compressed .gz files
gzip_static on;

# ==========================================================================
# Compression Ratios by Content Type (Reference)
# ==========================================================================
#
# These are typical compression ratios achieved:
#
# JavaScript:     ~70-80% reduction
# CSS:            ~70-80% reduction
# HTML:           ~60-70% reduction
# JSON:           ~70-85% reduction
# SVG:            ~60-80% reduction
# Plain text:     ~50-70% reduction
#
# Already compressed formats (do NOT compress):
# - JPEG, PNG, WEBP, AVIF (images)
# - WOFF2 (fonts - already compressed)
# - Video formats (MP4, WebM, etc.)
# - Audio formats (MP3, AAC, Opus, etc.)
# - Archive formats (ZIP, TAR.GZ, etc.)
#
# ==========================================================================

# ==========================================================================
# Content-Encoding Handling
# ==========================================================================

# Map to detect client compression support
map $http_accept_encoding $compression_support {
    default "";
    ~*br "br";
    ~*gzip "gzip";
}

# ==========================================================================
# Pre-compression Build Integration
# ==========================================================================
#
# For optimal performance, pre-compress static assets during build:
#
# Vite configuration (in vite.config.ts):
# - Use vite-plugin-compression for Brotli pre-compression
# - Generate .br files alongside original assets
#
# Build command example:
# npx vite build && find dist -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" -o -name "*.json" -o -name "*.svg" \) -exec brotli -k {} \;
#
# Nginx will automatically serve .br files when:
# 1. brotli_static is enabled
# 2. Client supports Brotli (br in Accept-Encoding)
# 3. Pre-compressed .br file exists alongside original
#
# ==========================================================================

# ==========================================================================
# Upstream Compression (for proxied content)
# ==========================================================================

# Decompress proxied responses if needed
# gunzip on;

# ==========================================================================
# Compression Monitoring
# ==========================================================================

# Custom log format with compression info
log_format compression '$remote_addr - [$time_local] "$request" '
                       '$status $body_bytes_sent '
                       'sent=$bytes_sent '
                       'gzip_ratio=$gzip_ratio '
                       '"$http_accept_encoding"';

# Uncomment to log compression metrics
# access_log /var/log/nginx/compression.log compression;

# ==========================================================================
# Performance Notes
# ==========================================================================
#
# CPU vs Bandwidth Trade-off:
# - Higher compression levels use more CPU
# - Use level 6 for dynamic content (on-the-fly compression)
# - Use level 11 for pre-compressed static assets during build
#
# Memory Usage:
# - Each compression operation uses temporary buffers
# - Configure buffers appropriately for expected traffic
#
# Monitoring:
# - Track $gzip_ratio in logs to measure effectiveness
# - Monitor CPU usage during high traffic
# - Consider CDN for static asset delivery
#
# ==========================================================================
