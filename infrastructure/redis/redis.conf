# ============================================================================
# YTFY Redis Configuration
# ============================================================================
# Purpose: Session caching, API response caching, rate limiting
# Optimized for: Low latency, high throughput, memory efficiency
# ============================================================================

# ==========================================================================
# Network Configuration
# ==========================================================================

# Bind to localhost only (security)
bind 127.0.0.1 ::1

# Port (default: 6379)
port 6379

# TCP backlog (adjust based on traffic)
tcp-backlog 511

# Unix socket (faster for local connections)
unixsocket /var/run/redis/redis.sock
unixsocketperm 770

# Close connection after client is idle for N seconds (0 = disable)
timeout 300

# TCP keepalive
tcp-keepalive 300

# ==========================================================================
# General Configuration
# ==========================================================================

# Run as daemon
daemonize yes

# PID file
pidfile /var/run/redis/redis-server.pid

# Log level (debug, verbose, notice, warning)
loglevel notice

# Log file (empty for stdout)
logfile /var/log/redis/redis-server.log

# Number of databases (default: 16)
# DB 0: Session cache
# DB 1: API response cache
# DB 2: Rate limiting
# DB 3: General application cache
databases 16

# ==========================================================================
# Memory Management
# ==========================================================================

# Maximum memory limit (adjust based on server RAM)
# For a dedicated cache server, use 70-80% of available RAM
maxmemory 2gb

# Eviction policy when maxmemory is reached
# allkeys-lru: Evict least recently used keys
# volatile-lru: Evict LRU keys with expire set
# allkeys-lfu: Evict least frequently used keys
# volatile-lfu: Evict LFU keys with expire set
# allkeys-random: Random eviction
# volatile-random: Random eviction of keys with expire
# volatile-ttl: Evict keys with shortest TTL
# noeviction: Return error on write operations
maxmemory-policy allkeys-lfu

# Number of samples for LRU/LFU algorithms
maxmemory-samples 10

# Active defragmentation (Redis 4.0+)
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# ==========================================================================
# Persistence Configuration
# ==========================================================================

# RDB persistence (background snapshots)
# Disabled for pure cache use case
# Uncomment to enable periodic snapshots

# save 900 1      # Save if at least 1 key changed in 900 seconds
# save 300 10     # Save if at least 10 keys changed in 300 seconds
# save 60 10000   # Save if at least 10000 keys changed in 60 seconds

# Disable RDB for pure cache (faster, less disk I/O)
save ""

# RDB filename
dbfilename dump.rdb

# Working directory
dir /var/lib/redis

# Stop accepting writes on RDB errors
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# RDB checksum
rdbchecksum yes

# AOF persistence (append-only file)
# Disabled for pure cache use case
appendonly no

# AOF filename
appendfilename "appendonly.aof"

# AOF fsync policy
# no: Don't fsync, let OS handle it (fastest)
# always: fsync after every write (slowest, safest)
# everysec: fsync once per second (good balance)
appendfsync everysec

# Disable fsync during rewrite (performance boost)
no-appendfsync-on-rewrite no

# ==========================================================================
# Replication Configuration
# ==========================================================================

# Master-replica configuration (uncomment for replication)
# replicaof <masterip> <masterport>

# Master password for replication
# masterauth <password>

# Replica serves stale data when disconnected
replica-serve-stale-data yes

# Replica is read-only
replica-read-only yes

# Diskless replication
repl-diskless-sync no
repl-diskless-sync-delay 5

# Ping replica period
repl-ping-replica-period 10

# Replication timeout
repl-timeout 60

# Disable TCP_NODELAY on replica
repl-disable-tcp-nodelay no

# Replication backlog size
repl-backlog-size 1mb

# Replica priority for election
replica-priority 100

# ==========================================================================
# Security Configuration
# ==========================================================================

# Require password for all operations
# Generate strong password: openssl rand -hex 32
# requirepass your-strong-password-here

# Rename dangerous commands (security hardening)
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG "CONFIG_b7a94c12"
rename-command SHUTDOWN "SHUTDOWN_b7a94c12"

# ==========================================================================
# Clients Configuration
# ==========================================================================

# Maximum connected clients
maxclients 10000

# ==========================================================================
# Memory Optimization
# ==========================================================================

# Hash table optimization
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List optimization
list-max-ziplist-size -2
list-compress-depth 0

# Set optimization
set-max-intset-entries 512

# Sorted set optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog optimization
hll-sparse-max-bytes 3000

# Stream optimization
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ==========================================================================
# Slow Log Configuration
# ==========================================================================

# Log queries slower than N microseconds
slowlog-log-slower-than 10000

# Maximum slow log entries
slowlog-max-len 128

# ==========================================================================
# Latency Monitoring
# ==========================================================================

# Enable latency monitoring (threshold in milliseconds)
latency-monitor-threshold 100

# ==========================================================================
# Event Notification
# ==========================================================================

# Keyspace notifications (subscribe to key events)
# K: Keyspace events
# E: Keyevent events
# g: Generic commands (DEL, EXPIRE, RENAME, ...)
# $: String commands
# l: List commands
# s: Set commands
# h: Hash commands
# z: Sorted set commands
# x: Expired events
# e: Evicted events
# A: Alias for "g$lshzxe"
notify-keyspace-events "Ex"

# ==========================================================================
# Lua Scripting
# ==========================================================================

# Maximum Lua script execution time (milliseconds)
lua-time-limit 5000

# ==========================================================================
# Cluster Configuration (if using Redis Cluster)
# ==========================================================================

# Uncomment for cluster mode
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 15000

# ==========================================================================
# Advanced Configuration
# ==========================================================================

# Dynamic HZ (adaptive server timer frequency)
dynamic-hz yes

# Server timer frequency (default: 10)
hz 10

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

# ==========================================================================
# Thread I/O Configuration (Redis 6.0+)
# ==========================================================================

# I/O threads for reading client commands
# Set to number of CPU cores - 2 (leave cores for main thread + OS)
io-threads 4

# Enable I/O threads for writes
io-threads-do-reads yes

# ==========================================================================
# TLS/SSL Configuration (if needed)
# ==========================================================================

# Uncomment for TLS support
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt
# tls-auth-clients no

# ==========================================================================
# Usage Patterns for YTFY Application
# ==========================================================================
#
# Database 0 - Session Cache:
#   Key pattern: session:{hash}
#   TTL: 30 days
#   Data: User session data, preferences
#
# Database 1 - API Response Cache:
#   Key pattern: api:{endpoint}:{params_hash}
#   TTL: 5 minutes to 1 hour (depending on endpoint)
#   Data: JSON API responses
#
# Database 2 - Rate Limiting:
#   Key pattern: ratelimit:{ip}:{endpoint}
#   TTL: 1 minute (sliding window)
#   Data: Request count
#
# Database 3 - Application Cache:
#   Key pattern: cache:{type}:{id}
#   TTL: Varies by data type
#   Data: Frequently accessed data
#
# Example commands:
#   SET session:abc123 "{...}" EX 2592000
#   GET api:videos:xyz789
#   INCR ratelimit:192.168.1.1:api
#   EXPIRE ratelimit:192.168.1.1:api 60
#
# ==========================================================================
